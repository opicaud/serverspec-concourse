#!/usr/bin/env ruby

require 'json'
require 'fileutils'


def create_host_directory(host)
    hostDir = "/serverspec/spec/" + host
    FileUtils.mkdir_p hostDir
end

def add_ssh_key(ssh_key)
    FileUtils.mkdir_p "/root/.ssh"
    ssh_key_file = File.join("/root/.ssh", "id_rsa")
    File.open(ssh_key_file, 'w') { |file| file.write(ssh_key) }
end



sSource = STDIN.read
source = JSON.parse(sSource)
host = source["source"]["host"]
user = source["source"]["user"]
ssh_key = source["source"]["ssh_key"]
tests = source["params"]["tests"]

sourceDir = ARGV[0]

create_host_directory(host)
add_ssh_key(ssh_key)

dest_folder = "/serverspec/spec/" + host
FileUtils.cp(File.join(sourceDir, tests), dest_folder)

Dir.chdir "/serverspec"

output = `rake`
STDERR.puts output

ret = {
    "version": {"host": host, "user": user},

    "metadata": [
        {"name": "a-metadata", "value":"out"}
    ]
}

puts ret.to_json