#!/usr/bin/env ruby

require 'json'
require 'fileutils'
require 'open3'
require_relative "lib/host.rb"


def add_ssh_key(ssh_key)
    FileUtils.mkdir_p "/root/.ssh"
    ssh_key_file = File.join("/root/.ssh", "id_rsa")
    File.open(ssh_key_file, 'w') { |file| file.write(ssh_key) }
end

def set_ssh_user(path, user)
    spec_helper_file = File.read(path)
    spec_helper_file_with_ssh_user_set = spec_helper_file.gsub(/{{ user }}/, user)
    File.open(path, "w") {|file| file.puts spec_helper_file_with_ssh_user_set }
end


sSource = STDIN.read
source = JSON.parse(sSource)
host = source["source"]["host"]
user = source["source"]["user"]
ssh_key = source["source"]["ssh_key"]
tests = source["params"]["tests"]

sourceDir = ARGV[0]

hostConfiguration = CreateHostConfiguration.new()

hostConfiguration.create_host_directory(host)
hostConfiguration.copy_spec_to_host_folder(File.join(sourceDir, tests),host)

add_ssh_key(ssh_key)
set_ssh_user("/serverspec/spec/spec_helper.rb", user)

Dir.chdir "/serverspec"

stdout, stderr, status = Open3.capture3("rake")



STDERR.puts stdout
STDERR.puts stderr

if not status.success?
  exit 1
end


ret = {
    "version": {"host": host, "user": user},

    "metadata": [
        {"name": "a-metadata", "value":"out"}
    ]
}

puts ret.to_json